<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizMaster – Создать квиз</title>
  <style>
    /* Сброс базовых отступов */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #333;
      padding-top: 80px; /* учёт фиксированной шапки */
    }
    /* Шапка (navbar) */
    header {
      width: 100%;
      height: 80px;
      padding: 0 40px;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #007BFF;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 30px;
    }
    nav ul li a {
      text-decoration: none;
      font-size: 16px;
      color: #007BFF;
      transition: color 0.3s;
    }
    nav ul li a:hover {
      color: #0056b3;
    }
    /* Стилизация кнопки Личный кабинет */
    .cabinet-button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .cabinet-button:hover {
      background-color: #0056b3;
    }
    /* Основной контейнер страницы */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 40px;
    }
    /* Блок для табов */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      color: #007BFF;
      border: 1px solid transparent;
      transition: background-color 0.3s, border 0.3s;
    }
    .tab.active {
      border: 1px solid #e0e0e0;
      border-bottom: none;
      background-color: #f8f8f8;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-weight: bold;
    }
    /* Контент табов */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Стили для блока создания квиза */
    #questions-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .question-block {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #f8f8f8;
      position: relative;
    }
    .question-block textarea.question-text {
      width: 100%;
      height: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      font-size: 14px;
      margin-bottom: 10px;
    }
    /* Поле корректного ответа всегда отображается */
    .question-block input.correct-answer {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .options-toggle {
      margin-bottom: 10px;
    }
    .options-toggle label {
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }
    .options-toggle input {
      margin-right: 5px;
    }
    .options-container {
      margin-top: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      border-radius: 4px;
      background: #fff;
      display: none;
    }
    .options-container .option {
      margin-bottom: 10px;
    }
    .options-container .option input {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-option-button {
      padding: 5px 10px;
      font-size: 14px;
      color: #007BFF;
      background: #fff;
      border: 1px solid #007BFF;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    .add-option-button:hover {
      background: #007BFF;
      color: #fff;
    }
    /* Кнопки внизу страницы */
    .add-question-button, .create-quiz-button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .add-question-button:hover, .create-quiz-button:hover {
      background: #0056b3;
    }
    /* Стили для раздела "Настройка" */
    #settings-tab-content {
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f8f8f8;
      font-size: 16px;
      color: #333;
    }
    .timer-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .timer-toggle label {
      margin-right: 10px;
      cursor: pointer;
    }
    .timer-toggle input {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .timer-input {
      width: 80px;
      padding: 5px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header>
    <div class="logo">QuizMaster</div>
    <nav>
      <ul>
        <li><a href="#">Создание квиза</a></li>
        <li><a href="#">Пройти квиз</a></li>
        <li><a href="#">Результаты</a></li>
        <li><a href="#">Мои квизы</a></li>
      </ul>
    </nav>
    <!-- Кнопка Личный кабинет -->
    <button class="cabinet-button" onclick="window.location.href='cabinet.html'">Личный кабинет</button>
  </header>

  <!-- Основной контент страницы "Создать квиз" -->
  <main>
    <!-- Табы -->
    <div class="tabs">
      <div class="tab active" data-tab="quiz-tab-content">Квиз</div>
      <div class="tab" data-tab="settings-tab-content">Настройка</div>
    </div>
    <!-- Контент табов -->
    <div id="quiz-tab-content" class="tab-content active">
      <!-- Контейнер для вопросов -->
      <div id="questions-container">
        <!-- Вопросы будут динамически добавляться -->
      </div>
      <button type="button" id="add-question" class="add-question-button">Добавить вопрос</button>
      <button type="button" id="create-quiz" class="create-quiz-button">Создать квиз</button>
    </div>
    <div id="settings-tab-content" class="tab-content">
      <div class="timer-toggle">
        <label for="timer-enabled">Включить таймер:</label>
        <input type="checkbox" id="timer-enabled">
        <label for="timer-value">Время (мин.):</label>
        <input type="number" id="timer-value" class="timer-input" min="1" value="1">
      </div>
      <!-- Дополнительные настройки можно добавить здесь -->
    </div>
  </main>

  <script>
    // Переключение табов
    const tabs = document.querySelectorAll(".tab");
    const tabContents = document.querySelectorAll(".tab-content");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        tabs.forEach(t => t.classList.remove("active"));
        tabContents.forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(target).classList.add("active");
      });
    });

    // Работа с динамическим добавлением вопросов
    const questionsContainer = document.getElementById("questions-container");
    const addQuestionButton = document.getElementById("add-question");
    const createQuizButton = document.getElementById("create-quiz");
    let questionCount = 0;
    const MAX_QUESTIONS = 30;

    // Функция для создания нового блока вопроса
    function createQuestionBlock() {
      if (questionCount >= MAX_QUESTIONS) {
        alert("Достигнуто максимальное число вопросов (" + MAX_QUESTIONS + ").");
        return;
      }
      questionCount++;
      const questionBlock = document.createElement("div");
      questionBlock.className = "question-block";
      questionBlock.innerHTML = `
        <textarea class="question-text" placeholder="Введите вопрос" required></textarea>
        <input type="text" class="correct-answer" placeholder="Введите корректный ответ" required>
        <div class="options-toggle">
          <label>
            <input type="checkbox" class="has-options"> Вопрос с вариантами ответа
          </label>
        </div>
        <div class="options-container">
          <div class="option">
            <input type="text" class="answer-option" placeholder="Вариант ответа">
          </div>
          <button type="button" class="add-option-button">+ Добавить вариант</button>
        </div>
      `;

      const hasOptionsCheckbox = questionBlock.querySelector(".has-options");
      const correctAnswerField = questionBlock.querySelector(".correct-answer");
      let optionsContainer = questionBlock.querySelector(".options-container");
      const addOptionButton = questionBlock.querySelector(".add-option-button");

      // Функция для прикрепления обработчика кнопки добавления вариантов
      function attachAddOptionHandler(container, button) {
        button.addEventListener("click", function() {
          const optionInputs = container.querySelectorAll(".answer-option");
          if (optionInputs.length >= 5) {
            alert("Можно добавить не более 5 вариантов ответа.");
            return;
          }
          const newOptionDiv = document.createElement("div");
          newOptionDiv.className = "option";
          newOptionDiv.innerHTML = `<input type="text" class="answer-option" placeholder="Вариант ответа">`;
          container.insertBefore(newOptionDiv, button);
        });
      }
      attachAddOptionHandler(optionsContainer, addOptionButton);

      // Обработка переключения чекбокса "Вопрос с вариантами ответа"
      hasOptionsCheckbox.addEventListener("change", function() {
        if (this.checked) {
          // При включении — показываем контейнер вариантов, но поле корректного ответа остаётся видимым
          optionsContainer.style.display = "block";
        } else {
          // При отключении — скрываем контейнер вариантов и сбрасываем его содержимое до исходного
          optionsContainer.innerHTML = `
            <div class="option">
              <input type="text" class="answer-option" placeholder="Вариант ответа">
            </div>
            <button type="button" class="add-option-button">+ Добавить вариант</button>
          `;
          attachAddOptionHandler(optionsContainer, optionsContainer.querySelector('.add-option-button'));
          optionsContainer.style.display = "none";
        }
      });

      questionsContainer.appendChild(questionBlock);
    }

    // Добавляем первый вопрос при загрузке страницы
    createQuestionBlock();
    addQuestionButton.addEventListener("click", createQuestionBlock);

    // Обработка кнопки "Создать квиз"
    createQuizButton.addEventListener("click", function() {
      const quizData = {
        questions: [],
        settings: {}
      };

      // Собираем данные по каждому вопросу
      const questionBlocks = document.querySelectorAll(".question-block");
      questionBlocks.forEach((block) => {
        const questionText = block.querySelector(".question-text").value.trim();
        const correctAnswer = block.querySelector(".correct-answer").value.trim();
        const hasOptions = block.querySelector(".has-options").checked;
        let question = {
          text: questionText,
          correctAnswer: correctAnswer,
          hasOptions: hasOptions
        };

        if (hasOptions) {
          const optionInputs = block.querySelectorAll(".answer-option");
          const options = [];
          optionInputs.forEach(input => {
            const val = input.value.trim();
            if (val) options.push(val);
          });
          question.options = options;
        }
        quizData.questions.push(question);
      });

      // Собираем настройки из второго таба
      const timerEnabled = document.getElementById("timer-enabled").checked;
      quizData.settings.timerEnabled = timerEnabled;
      if (timerEnabled) {
        // Перевод из минут в секунды
        quizData.settings.timerValue = parseInt(document.getElementById("timer-value").value, 10) * 60 || 60;
      }

      console.log("Собранные данные квиза:", JSON.stringify(quizData, null, 2));

      // Отправка данных на сервер
      fetch('/api/quizzes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(quizData)
      })
      .then(response => {
        if (!response.ok) throw new Error('Ошибка создания квиза');
        return response.json();
      })
      .then(data => {
        alert("Квиз успешно создан!");
        window.location.href = "/cabinet.html";
      })
      .catch(error => {
        console.error("Ошибка:", error);
        alert("Ошибка при создании квиза. Попробуйте снова.");
      });
    });
  </script>
</body>
</html>
