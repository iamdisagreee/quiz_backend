<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuizMaster – Создать квиз</title>
  <style>
    /* Сброс базовых отступов */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #ffffff;
      color: #333;
      padding-top: 80px; /* учёт фиксированной шапки */
    }
    /* Шапка (navbar) */
    header {
      width: 100%;
      height: 80px;
      padding: 0 40px;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #007BFF;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 30px;
    }
    nav ul li a {
      text-decoration: none;
      font-size: 16px;
      color: #007BFF;
      transition: color 0.3s;
    }
    nav ul li a:hover {
      color: #0056b3;
    }
    /* Стилизация кнопки Личный кабинет */
    .cabinet-button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .cabinet-button:hover {
      background-color: #0056b3;
    }
    /* Основной контейнер страницы */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 40px;
    }
    /* Блок для табов */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      color: #007BFF;
      border: 1px solid transparent;
      transition: background-color 0.3s, border 0.3s;
    }
    .tab.active {
      border: 1px solid #e0e0e0;
      border-bottom: none;
      background-color: #f8f8f8;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-weight: bold;
    }
    /* Контент табов */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Стили для блока информации о квизе */
    .quiz-info {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border: 1px solid #add8e6;
      border-radius: 8px;
    }
    .quiz-info input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .quiz-info label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    /* Стили для блока создания квиза */
    #questions-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .question-block {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #f8f8f8;
      position: relative;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .question-number {
      font-weight: bold;
      color: #007BFF;
    }
    .remove-question {
      background: none;
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      font-size: 18px;
    }
    .question-block textarea.question-text {
      width: 100%;
      height: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .question-type-selector {
      margin-bottom: 15px;
    }
    .question-type-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background-color: #fff;
    }
    /* Контейнер для текстового ответа */
    .text-answer-container {
      margin-bottom: 15px;
    }
    .text-answer-container input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    /* Контейнер для вариантов ответа */
    .options-container {
      margin-top: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      border-radius: 4px;
      background: #fff;
    }
    .option-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    .option-input {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .is-correct-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .is-correct-radio {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .option-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .add-option-button {
      padding: 5px 10px;
      font-size: 14px;
      color: #007BFF;
      background: #fff;
      border: 1px solid #007BFF;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    .add-option-button:hover {
      background: #007BFF;
      color: #fff;
    }
    .remove-option-button {
      background: none;
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      font-size: 16px;
      padding: 0 5px;
    }
    /* Кнопки внизу страницы */
    .add-question-button, .create-quiz-button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .add-question-button:hover, .create-quiz-button:hover {
      background: #0056b3;
    }
    /* Стили для раздела "Настройка" */
    #settings-tab-content {
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f8f8f8;
      font-size: 16px;
      color: #333;
    }
    .timer-toggle {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .timer-toggle label {
      margin-right: 10px;
      cursor: pointer;
    }
    .timer-toggle input {
      margin-right: 10px;
      transform: scale(1.2);
    }
    .timer-input {
      width: 80px;
      padding: 5px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<!-- Шапка -->
<header>
  <div class="logo">QuizMaster</div>
  <nav>
    <ul>
      <li><a href="#">Создание квиза</a></li>
      <li><a href="#">Пройти квиз</a></li>
      <li><a href="#">Результаты</a></li>
      <li><a href="#">Мои квизы</a></li>
    </ul>
  </nav>
  <!-- Кнопка Личный кабинет -->
  <button class="cabinet-button" onclick="window.location.href='cabinet.html'">Личный кабинет</button>
</header>

<!-- Основной контент страницы "Создать квиз" -->
<main>
  <!-- Информация о квизе -->
  <div class="quiz-info">
    <label for="quiz-name">Название квиза</label>
    <input type="text" id="quiz-name" placeholder="Введите название квиза" required>
  </div>

  <!-- Табы -->
  <div class="tabs">
    <div class="tab active" data-tab="quiz-tab-content">Вопросы</div>
    <div class="tab" data-tab="settings-tab-content">Настройка</div>
  </div>
  
  <!-- Контент табов -->
  <div id="quiz-tab-content" class="tab-content active">
    <!-- Контейнер для вопросов -->
    <div id="questions-container">
      <!-- Вопросы будут динамически добавляться -->
    </div>
    <button type="button" id="add-question" class="add-question-button">Добавить вопрос</button>
    <button type="button" id="create-quiz" class="create-quiz-button">Создать квиз</button>
  </div>
  
  <div id="settings-tab-content" class="tab-content">
    <div class="timer-toggle">
      <label for="timer-enabled">Включить таймер:</label>
      <input type="checkbox" id="timer-enabled">
      <label for="timer-value">Время (мин.):</label>
      <input type="number" id="timer-value" class="timer-input" min="1" value="15">
    </div>
    <!-- Дополнительные настройки можно добавить здесь -->
  </div>
</main>

<script>
  // Переключение табов
  const tabs = document.querySelectorAll(".tab");
  const tabContents = document.querySelectorAll(".tab-content");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const target = tab.getAttribute("data-tab");
      tabs.forEach(t => t.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(target).classList.add("active");
    });
  });

  // Работа с динамическим добавлением вопросов
  const questionsContainer = document.getElementById("questions-container");
  const addQuestionButton = document.getElementById("add-question");
  const createQuizButton = document.getElementById("create-quiz");
  let questionCount = 0;
  const MAX_QUESTIONS = 30;

  // Функция для создания нового блока вопроса
  function createQuestionBlock() {
    if (questionCount >= MAX_QUESTIONS) {
      alert("Достигнуто максимальное число вопросов (" + MAX_QUESTIONS + ").");
      return;
    }
    
    questionCount++;
    const questionBlock = document.createElement("div");
    questionBlock.className = "question-block";
    questionBlock.dataset.questionIndex = questionCount;
    
    // Основная структура блока вопроса
    questionBlock.innerHTML = `
      <div class="question-header">
        <span class="question-number">Вопрос ${questionCount}</span>
        <button type="button" class="remove-question" title="Удалить вопрос">×</button>
      </div>
      
      <textarea class="question-text" placeholder="Введите вопрос" required></textarea>
      
      <div class="question-type-selector">
        <select class="question-type">
          <option value="text">Текстовый ответ</option>
          <option value="single_choice">Одиночный выбор</option>
          <option value="multiple_choice">Множественный выбор</option>
        </select>
      </div>
      
      <!-- Контейнер для текстового ответа -->
      <div class="text-answer-container">
        <input type="text" class="text-answer" placeholder="Введите правильный ответ" required>
      </div>
      
      <!-- Контейнер для вариантов ответа (скрыт по умолчанию) -->
      <div class="options-container" style="display: none;">
        <div class="option-item">
          <input type="text" class="option-input" placeholder="Вариант ответа">
          <input type="radio" name="correct-option-${questionCount}" class="is-correct-radio" title="Отметить как правильный" checked>
          <button type="button" class="remove-option-button" title="Удалить вариант">×</button>
        </div>
        <div class="option-controls">
          <button type="button" class="add-option-button">+ Добавить вариант</button>
        </div>
      </div>
    `;

    // Обработчик выбора типа вопроса
    const questionTypeSelect = questionBlock.querySelector(".question-type");
    const textAnswerContainer = questionBlock.querySelector(".text-answer-container");
    const optionsContainer = questionBlock.querySelector(".options-container");
    
    questionTypeSelect.addEventListener("change", function() {
      const questionType = questionTypeSelect.value;
      
      // Скрываем все контейнеры
      textAnswerContainer.style.display = "none";
      optionsContainer.style.display = "none";
      
      // Показываем нужный контейнер в зависимости от типа вопроса
      switch (questionType) {
        case "text":
          textAnswerContainer.style.display = "block";
          break;
          
        case "single_choice":
          optionsContainer.style.display = "block";
          // Обновляем на радиокнопки для одиночного выбора
          updateOptionsForSingleChoice(optionsContainer, questionCount);
          break;
          
        case "multiple_choice":
          optionsContainer.style.display = "block";
          // Обновляем на чекбоксы для множественного выбора
          updateOptionsForMultipleChoice(optionsContainer);
          break;
      }
    });
    
    // Обработчик кнопки добавления варианта ответа
    const addOptionButton = questionBlock.querySelector(".add-option-button");
    addOptionButton.addEventListener("click", function() {
      const optionItems = optionsContainer.querySelectorAll(".option-item");
      if (optionItems.length >= 10) {
        alert("Можно добавить не более 10 вариантов ответа.");
        return;
      }
      
      const questionType = questionTypeSelect.value;
      const newOptionItem = document.createElement("div");
      newOptionItem.className = "option-item";
      
      if (questionType === "single_choice") {
        newOptionItem.innerHTML = `
          <input type="text" class="option-input" placeholder="Вариант ответа">
          <input type="radio" name="correct-option-${questionCount}" class="is-correct-radio" title="Отметить как правильный">
          <button type="button" class="remove-option-button" title="Удалить вариант">×</button>
        `;
      } else {
        newOptionItem.innerHTML = `
          <input type="text" class="option-input" placeholder="Вариант ответа">
          <input type="checkbox" class="is-correct-checkbox" title="Отметить как правильный">
          <button type="button" class="remove-option-button" title="Удалить вариант">×</button>
        `;
      }
      
      // Добавляем обработчик для кнопки удаления варианта
      const removeOptionButton = newOptionItem.querySelector(".remove-option-button");
      removeOptionButton.addEventListener("click", function() {
        newOptionItem.remove();
      });
      
      // Добавляем новый вариант перед контролами
      optionsContainer.insertBefore(newOptionItem, optionsContainer.querySelector(".option-controls"));
    });
    
    // Добавляем обработчик для кнопки удаления первого варианта
    const removeOptionButtons = questionBlock.querySelectorAll(".remove-option-button");
    removeOptionButtons.forEach(button => {
      button.addEventListener("click", function() {
        const optionItem = button.closest(".option-item");
        optionItem.remove();
      });
    });
    
    // Обработчик кнопки удаления вопроса
    const removeQuestionButton = questionBlock.querySelector(".remove-question");
    removeQuestionButton.addEventListener("click", function() {
      if (confirm("Вы уверены, что хотите удалить этот вопрос?")) {
        questionBlock.remove();
        questionCount--;
        // Обновляем нумерацию вопросов
        updateQuestionNumbers();
      }
    });

    questionsContainer.appendChild(questionBlock);
    return questionBlock;
  }
  
  // Функция для обновления нумерации вопросов
  function updateQuestionNumbers() {
    const questionBlocks = document.querySelectorAll(".question-block");
    questionBlocks.forEach((block, index) => {
      block.querySelector(".question-number").textContent = `Вопрос ${index + 1}`;
    });
  }
  
  // Функция для обновления вариантов на радиокнопки (одиночный выбор)
  function updateOptionsForSingleChoice(container, questionIndex) {
    const optionItems = container.querySelectorAll(".option-item");
    
    optionItems.forEach(item => {
      // Заменяем чекбокс на радиокнопку
      const oldInput = item.querySelector("input[type='checkbox']");
      if (oldInput) {
        const wasChecked = oldInput.checked;
        const radioInput = document.createElement("input");
        radioInput.type = "radio";
        radioInput.className = "is-correct-radio";
        radioInput.name = `correct-option-${questionIndex}`;
        radioInput.title = "Отметить как правильный";
        radioInput.checked = wasChecked;
        
        oldInput.replaceWith(radioInput);
      }
    });
  }
  
  // Функция для обновления вариантов на чекбоксы (множественный выбор)
  function updateOptionsForMultipleChoice(container) {
    const optionItems = container.querySelectorAll(".option-item");
    
    optionItems.forEach(item => {
      // Заменяем радиокнопку на чекбокс
      const oldInput = item.querySelector("input[type='radio']");
      if (oldInput) {
        const wasChecked = oldInput.checked;
        const checkboxInput = document.createElement("input");
        checkboxInput.type = "checkbox";
        checkboxInput.className = "is-correct-checkbox";
        checkboxInput.title = "Отметить как правильный";
        checkboxInput.checked = wasChecked;
        
        oldInput.replaceWith(checkboxInput);
      }
    });
  }

  // Добавляем первый вопрос при загрузке страницы
  createQuestionBlock();
  
  // Обработчик кнопки добавления вопроса
  addQuestionButton.addEventListener("click", createQuestionBlock);

  // Обработка кнопки "Создать квиз"
  createQuizButton.addEventListener("click", function() {
    // Получаем название квиза
    const quizName = document.getElementById("quiz-name").value.trim();
    if (!quizName) {
      alert("Пожалуйста, введите название квиза");
      return;
    }
    
    // Структура данных для отправки на сервер
    const quizData = {
      name: quizName,
      questions: [],
      settings: {}
    };
    
    // Собираем данные по каждому вопросу
    const questionBlocks = document.querySelectorAll(".question-block");
    let isValid = true;
    
    questionBlocks.forEach((block) => {
      const questionText = block.querySelector(".question-text").value.trim();
      if (!questionText) {
        alert("Заполните текст вопроса");
        isValid = false;
        return;
      }
      
      const questionType = block.querySelector(".question-type").value;
      const question = {
        text: questionText,
        type: questionType,
        answers: []
      };
      
      // В зависимости от типа вопроса собираем ответы
      switch (questionType) {
        case "text":
          const textAnswer = block.querySelector(".text-answer").value.trim();
          if (!textAnswer) {
            alert(`Заполните правильный ответ для вопроса "${questionText}"`);
            isValid = false;
            return;
          }
          question.answers = [{ text: textAnswer, isCorrect: true }];
          break;
          
        case "single_choice":
        case "multiple_choice":
          const optionItems = block.querySelectorAll(".option-item");
          let hasCorrectAnswer = false;
          
          optionItems.forEach(item => {
            const optionText = item.querySelector(".option-input").value.trim();
            if (!optionText) {
              alert(`Заполните текст варианта ответа для вопроса "${questionText}"`);
              isValid = false;
              return;
            }
            
            let isCorrect;
            if (questionType === "single_choice") {
              isCorrect = item.querySelector(".is-correct-radio").checked;
            } else {
              isCorrect = item.querySelector(".is-correct-checkbox").checked;
            }
            
            if (isCorrect) hasCorrectAnswer = true;
            
            question.answers.push({
              text: optionText,
              isCorrect: isCorrect
            });
          });
          
          // Проверяем, что у вопроса с вариантами есть хотя бы два варианта
          if (optionItems.length < 2) {
            alert(`Добавьте минимум два варианта ответа для вопроса "${questionText}"`);
            isValid = false;
            return;
          }
          
          // Проверяем, что есть хотя бы один правильный ответ
          if (!hasCorrectAnswer) {
            alert(`Отметьте хотя бы один правильный ответ для вопроса "${questionText}"`);
            isValid = false;
            return;
          }
          break;
      }
      
      quizData.questions.push(question);
    });
    
    if (!isValid) return;
    
    // Проверяем, что в квизе есть вопросы
    if (quizData.questions.length === 0) {
      alert("Добавьте хотя бы один вопрос в квиз");
      return;
    }
    
    // Собираем настройки из второго таба
    const timerEnabled = document.getElementById("timer-enabled").checked;
    quizData.settings.timerEnabled = timerEnabled;
    if (timerEnabled) {
      quizData.settings.timerValue = parseInt(document.getElementById("timer-value").value, 10) || 15;
    }

    console.log("Данные квиза для отправки:", JSON.stringify(quizData, null, 2));

    // Отправка данных на сервер
    fetch('/api/quizzes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quizData)
    })
    .then(response => {
      if (!response.ok) throw new Error('Ошибка создания квиза');
      return response.json();
    })
    .then(data => {
      alert("Квиз успешно создан!");
      window.location.href = "/cabinet.html";
    })
    .catch(error => {
      console.error("Ошибка:", error);
      alert("Ошибка при создании квиза. Попробуйте снова.");
    });
  });
</script>
</body>
</html>
